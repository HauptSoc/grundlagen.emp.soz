---
title: "Week 10: Two-way ANOVA"
format: 
  revealjs:
    theme: style.scss
editor: source
---

```{r}
#| include: false
#| label: set-up

library(tidyverse)
library(lterdatasampler)
library(openintro)
library(moderndive)
library(infer)
library(ggridges)
library(broom)
library(gt)
library(RColorBrewer)
library(car)

hbr_maples_ref <- hbr_maples %>% 
  filter(watershed == "Reference") %>% 
  slice_sample(n = 150)

hbr_maples_w1 <- hbr_maples %>% 
  filter(watershed == "W1") %>% 
  slice_sample(n = 75)
  
hbr_maples_small <- bind_rows(hbr_maples_w1, 
                              hbr_maples_ref) %>% 
  mutate(year_cat = as.factor(year)
         ) 
```

# Lab 8 Recap

## Common Mistakes

</br>

:::{.small}
**Questions 1 & 2** -- Your axis labels should contain units and indicate if your variables were transformed! 

</br>

:::{.fragment}
**Question 6** -- Equal variance is not about equal points above and below the line! 
:::

</br>

:::{.fragment}
**Question 11** -- Your hypothesis test decision should state what $\alpha$ was used!
:::

</br>

:::{.fragment}
**Question 15** -- Both theory-based and simulation-based methods have conditions and the reliability of a p-value depends on those conditions. 
:::
:::

# Week 10

## Wrapping Up Revisions

The final round of revisions on **all** assignments are due by Sunday, June 8.

. . .

::: callout-caution
# One round of revisions

You will only have time for ***one*** round of revisions on Lab 8 and
Statistical Critique 2, so make sure you feel confident about your revisions.
:::

## Final Project

-   Feedback (from me) will be provided by Wednesday's class
-   Peer feedback on Wednesday
    -   Come with a poster outline!

# Two-Way ANOVA Models

## 

::: {style="font-size: 3em; color: #000000;"}
Two-way ANOVA
:::

</br>

::: {style="font-size: 2em; color: #0F4C81;"}
Goal:
:::

Assess if [multiple]{.underline} categorical variables have a relationship with the response.

## HBR Maples

:::{.midi}
The `hbr_maples` dataset contains observations on sugar maple seedlings in
untreated and calcium-amended watersheds at Hubbard Brook Experimental Forest in
New Hampshire.
:::

::: columns
::: {.column width="60%"}
::: {.small}
::: {.incremental}
- Both watersheds are located on the south-facing slope (average slope angle
20-30%) of the Hubbard Brook valley.
- These watersheds were chosen to minimize differences in site characteristics
between treatment and reference sites. 
- In October 1999, 55 Mg of powdered and pelletized wollastonite (CaSi03) was 
applied by helicopter to W1, while no treatment was applied to the reference 
watershed. 
:::
:::
:::

::: {.column width="5%"}
:::

::: {.column width="35%"}
![](images/hbr-maples-watersheds.png){fig-alt="A Google Maps image of the two watersheds studied in the HBR maples dataset. Each watershed is outlined in a yellow rectangle, where the rectangles have a moderate amount of area between them. This is presumably so that the calcuium treatment from one watershed did not transport to the adjacent watershed."}
:::
:::

## Experimental Design

::: {.small}
> Sugar maple germinants were collected in early August 2003 (first-year
> germinants) and 2004 (second-year germinants) from randomly placed transects
> in the treated watershed (W1) and in the reference plots located adjacent to
> W1. In 2003, sampling was stratified by elevation, with 120 seedlings each
> collected from treated and reference areas in the low- and mid-elevation zones
> of the watersheds.

:::

::: {.incremental}
::: {.small}
- What are the treatments?
- What are the experimental units? (i.e., to whom was the treatment applied?)
- Is there replication in this study?
- Is there pseudoreplication in this study?
- What confounding variables did the researchers attempt to control?
:::
:::

## Two-Way ANOVA

There seem to be three "key" variables in this study:

- treatment (calcium, reference)
- elevation (low, medium)
- year of collection (2003, 2004)

## Modeling Options

::::::::: columns
::::: {.column width="50%"}
::: {style="font-size: 1.25em; color: #ed8402;"}
Additive Model
:::

::: fragment
Each explanatory variable has a meaningful relationship with the response, conditional on the variable(s) included in the model.
:::
:::::

::::: {.column width="50%"}
::: {style="font-size: 1.25em; color: #0F4C81;"}
Interaction Model
:::

::: fragment
The relationship between one categorical explanatory variable and the response **differs** based on the values of another categorical variable.
:::
:::::
:::::::::

# Interaction Two-way ANOVA

## Research Question

> Does the relationship between mean stem dry mass and calcium treatment for
> sugar maples differ based on the year the seedling was sampled?

. . .

</br>

Or, because the study was an experiment...

> Does the *effect* of calcium treatment on the stem dry mass of sugar maples
differ based on the year the seedling was sampled?

## What are we looking for?

```{r}
#| label: twa-plot-year

hbr_maples_small %>% 
  ggplot(mapping = aes(y = year_cat, x = stem_dry_mass, fill = watershed)) + 
  geom_density_ridges(alpha = 0.5, scale = 1) +
  labs(y = "",
       title = "Effect of Calcium Treatment on Sugar Maples Across Different Years",
       x = "Stem Dry Mass (g)", 
       fill = "") + 
  theme_bw() +
  theme(axis.title = element_text(size = 18), 
        axis.text = element_text(size = 16), 
        legend.text = element_text(size = 16),
        legend.title = element_text(size = 18), 
        plot.title = element_text(size = 18),
        legend.position = "top")
```

<!-- ## Another way to think about it... -->

<!-- ```{r} -->
<!-- #| label: twa-facet-maples -->
<!-- #| echo: false -->

<!-- hbr_maples_small %>%  -->
<!--   ggplot(aes(y = year_cat, x = stem_dry_mass)) +  -->
<!--   geom_density_ridges(alpha = 0.5, scale = 1) + -->
<!--   facet_wrap(~ watershed) + -->
<!--   labs(y = "", -->
<!--        title = "Effect of Calcium Treatment on Sugar Maples Across Different Years", -->
<!--        x = "Stem Dry Mass (g)",  -->
<!--        fill = "") +  -->
<!--   theme(axis.title = element_text(size = 18),  -->
<!--         axis.text = element_text(size = 16),  -->
<!--         legend.text = element_text(size = 16), -->
<!--         legend.title = element_text(size = 18),  -->
<!--         plot.title = element_text(size = 18), -->
<!--         legend.position = "top") -->
<!-- ``` -->

## Conditions

-   Independence of observations

::: small
> Observations are independent *within* groups **and** *between* groups
:::

. . .

-   Equal variability of the groups

::: small
> The spread of the distributions are similar across groups
:::

. . .

-   Normality of the residuals / responses

::: small
> The distribution of responses for each group is approximately normal
:::

## Theory-based Two-Way ANOVA

```{r}
#| echo: true
#| eval: false
#| label: twa-interaction-code
#| code-line-numbers: false

maple_lm <- lm(stem_dry_mass ~ watershed * year_cat, 
               data = hbr_maples_small)

anova(maple_lm)
```

```{r}
#| label: twa-interaction-table

maple_lm <- lm(stem_dry_mass ~ watershed * year_cat, 
               data = hbr_maples_small)

anova(maple_lm) %>% 
  
  tidy() %>% 
  rename(`Sum Sq` = sumsq, 
          Df = df, 
         `Mean Sq` = meansq, 
          `F value` = statistic, 
          `Pr(>F)` = p.value) %>% 
  gt::gt()
```

. . .

::: small
The `watershed:year_cat` line is testing if the relationship between the calcium treatment (`watershed`) and mean stem dry mass differs between 2003 and 2004.
:::

. . .

</br>

::: {.centered}
Does it? [Does that make sense?]{.fragment}
:::

## How are those p-values calculated?

The p-values in the previous table use **Type I** sums of squares.

> Type I sums of squares are "sequential," meaning variables are tested in the order they are listed.

. . .

</br>

So, the p-value for `watershed:year_cat` is **conditional** on including `watershed` and `year_cat` as explanatory variables.

. . .

</br>

::: {.centered}
Is that what we want????
:::

## Testing "main effects"

If there is evidence of an interaction, we **do not** test if the main effects are "significant."

. . .

</br>

::: {.centered}
Why?
:::

. . .

</br>

The interactions depend on these variables, so they should be included in the model!

## Interpreting "main effects"

When interaction effects are present, an interpretation of main effects is incomplete or misleading

::: centered
![](images/car-interaction.png)
:::

# Additive Two-way ANOVA

## What if our analysis found no evidence of an interaction?

```{r}
#| echo: false
#| label: twa-plot-watershed
#| fig-align: center

hbr_maples_small %>% 
  drop_na(elevation) %>% 
  ggplot(mapping = aes(y = elevation, x = stem_dry_mass, fill = watershed)) + 
  geom_density_ridges(alpha = 0.5, scale = 1) +
  labs(y = "",
       title = "Effect of Calcium Treatment on Stem Dry Mass Across Different Elevations",
       x = "Stem Dry Mass (g)", 
       fill = "") + 
  theme(axis.title = element_text(size = 18), 
        axis.text = element_text(size = 16), 
        legend.text = element_text(size = 16),
        legend.title = element_text(size = 18), 
        plot.title = element_text(size = 18),
        legend.position = "top")
```

## Why would there be no interaction with `elevation`?

::: {.small}
> For most of these measurements, sampling was stratified by elevation zone. 
> There were three elevation zones designated within the northern
> hardwood-dominated forest in and adjacent to W1: low (500-550m), middle
> (550-600 m), and high (600-700 m).

:::

::: {.small}
::: {.incremental}
- What role does `elevation` play in this experiment?
- Should a blocking variable have an interaction with the treatment?
:::
:::

::: {.fragment}
::: {.small}
::: {.callout-tip}
If there is a significant interaction between the block and the treatment, it
means the treatment's effect changes depending on the block. That would violate
the basic idea of blocking: the block adds noise (i.e., shifts means up or
down), but doesnâ€™t interfere with how the treatment works. 
:::
:::
:::

## Testing for a relationship for each variable

::: {.midi}
```{r}
#| echo: true
#| eval: false
#| label: anova-elevation-first-code
#| code-line-numbers: false

additive_lm <- lm(stem_dry_mass ~ elevation + watershed, 
    data = hbr_maples_small) 

anova(additive_lm) %>% 
  tidy()
```
:::

</br>

```{r}
#| echo: false
#| label: anova-elevation-first

additive_lm <- lm(stem_dry_mass ~ elevation + watershed, 
    data = hbr_maples_small) 

anova(additive_lm) %>% 
  tidy() %>% 
  rename(`Sum Sq` = sumsq, 
          Df = df, 
          `Mean Sq` = meansq,
          `F value` = statistic, 
          `Pr(>F)` = p.value) %>% 
  gt() 
```

</br>

. . .

::: {style="text-align: center;"}
Do you think it matters which variable comes first?
:::

## Let's see...

::: {.midi}
```{r}
#| echo: true
#| eval: false
#| code-line-numbers: false
#| label: anov-watershed-first-code

additive_lm <- lm(stem_dry_mass ~ watershed + elevation, 
    data = hbr_maples_small) 

anova(additive_lm) %>% 
  tidy()
```
:::

</br>

```{r}
#| echo: false
#| label: anov-watershed-first

additive_lm <- lm(stem_dry_mass ~ watershed + elevation, 
    data = hbr_maples_small) 

anova(additive_lm) %>% 
  tidy() %>% 
  rename(`Sum Sq` = sumsq, 
          Df = df, 
          `Mean Sq` = meansq,
          `F value` = statistic, 
          `Pr(>F)` = p.value) %>% 
  gt() 
```

</br>

::: {.centered}
Did we get the same p-values as before?
:::

## Sequential Versus Partial Sums of Squares

Similar to before, the p-values in the ANOVA table use Type I (sequential) sums of squares.

:::: incremental
::: small
-   The p-value for each variable is conditional on the variable(s) that came *before* it.
-   The p-value for `elevation` is conditional on `watershed` being included in the model.
-   The p-value for `watershed` is conditional on...nothing.
:::
::::

. . .

::: small
If we want the p-value for each explanatory variable to be conditional on **every** variable included in the model, then we need to use a different type of sums of squares!
:::

## Partial Sums of Squares

> Type III sums of squares are "partial," meaning every term in the model is tested in light of the other terms in the model.

. . .

::: small
-   The p-value for `elevation` is conditional on `watershed` being included in the model
-   The p-value for `watershed` is conditional on `elevation` being included in the model
:::

. . .

::: callout-tip
# Only different for variables that *were not* first

We will get the same p-value for every variable that wasn't first, since they
were already conditional on the previous variables!
:::

## Getting the Conditional Tests for Every Variable

::: callout-tip
# Load in the `car` package!
:::

::: {.midi}
```{r}
#| echo: true
#| eval: false
#| label: anova-lm-code
#| code-line-numbers: false

library(car)

water_elev_lm <- lm(stem_dry_mass ~ watershed + elevation, 
    data = hbr_maples_small) 

Anova(water_elev_lm, type = "III")
```
:::

## Additive Model Hypothesis Tests

```{r}
#| echo: false
#| label: anova-lm-table

water_elev_lm <- lm(stem_dry_mass ~ watershed + elevation, 
    data = hbr_maples_small) 

Anova(water_elev_lm, type = "III") %>% 
  tidy() %>% 
  rename(`Sum Sq` = sumsq, 
          Df = df, 
          `F value` = statistic, 
          `Pr(>F)` = p.value) %>% 
  gt::gt()
```

</br>

:::: {style="text-align: center;"}
**What do you think the is the `elevation` line testing?**

::: {.fragment}
> Is there a difference in the mean stem dry mass between low and high elevation, 
> **conditional** on the watershed the seedling was grown in. 

:::

::: fragment
**What would you decide?**
:::
::::

## Should a blocking variable have a "significant" effect?

::: {.midi}
In the previous ANOVA table, we saw that `elevation` had a "significant" 
effect on the mean stem dry mass. 
:::

</br>

::: {.midi}
::: {.fragment}
Should a blocking variable have a "significant" effect on the response?
:::
:::

</br>

::: {.midi}
::: {.fragment}
What happened if the blocking variable did not have a "significant" effect?
:::
:::

## If the blocking variable is not "significant" should you delete it?

. . .

</br>

::: {.centered}
No!
:::

</br>

. . .

Even "non-significant" variables explain some amount of the variation in the
response. Which makes your estimates of a treatment effect more precise!

# Work Session

## Your Options

1.  Complete your revisions on Lab 8
2.  Complete your revisions on Statistical Critique 2
3.  Start moving your Final Project over to your poster
